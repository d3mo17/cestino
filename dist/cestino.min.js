!function(t,e){"function"==typeof define&&define.amd?define("cestino/BasicCartService",["bluebird/js/browser/bluebird.min","atomicjs/dist/atomic.min"],e):"object"==typeof module&&module.exports?module.exports=e(require("bluebird"),require("atomicjs")):(t.Cestino=t.Cestino||{},t.Cestino.BasicCartService=e(t.Promise,t.atomic))}(this,function(t,e){"use strict";function i(t){var e;this.options=JSON.parse(JSON.stringify(r));for(e in t)this.options[e]=t[e]}function n(t,e){e.walk(function(i){var n,o,r=[];if(!(i.product.id in t))return void e.deletePosition(i.id);n=t[i.product.id],i.product.title=n.title,i.product.price=n.price,i.features.forEach(function(t,e){if(!(t.id in n.features))return void r.push(e);t.label=n.features[t.id].label,t.price=n.features[t.id].price}),o=r.pop();for(;o;)i.features.splice(o,1)[0],o=r.pop()})}function o(i){var o=this,r={};return i.walk(function(t){r[t.product.id]=t.features.map(function(t){return t.id})}),new t(function(t,s){e.ajax({url:o.options.url,type:"POST",data:r}).error(s).success(function(e){n.call(o,e,i),t(e)})})}var r={url:""};return i.prototype={setProductDataToCart:o},{create:function(t){return new i(t)}}}),function(t,e){"function"==typeof define&&define.amd?define("cestino/Util",e):"object"==typeof module&&module.exports?module.exports=e():(t.Cestino=t.Cestino||{},t.Cestino.Util=e())}(this,function(){"use strict";function t(t){return t===+t&&t===(0|t)}function e(t){return!t||"0"===t}function i(e,i,n){var o;if(!t(i))throw new TypeError("Parameter width has to be an int!");return e+="",e.length>=i?e:(n=n||"0",n+="",o=new Array(Math.ceil((i-e.length)/n.length)+1).join(n),o.slice(0,i-e.length)+e)}return{isInt:t,isEmpty:e,lpad:i}}),function(t,e){"function"==typeof define&&define.amd?define("cestino/PriceFormatter",["cestino/Util"],e):"object"==typeof module&&module.exports?module.exports=e(require("./Util")):(t.Cestino=t.Cestino||{},t.Cestino.PriceFormatter=e(t.Cestino.Util))}(this,function(t){"use strict";function e(t,e,i){if(i=i||2,e=e||"",-1===[2,3].indexOf(i))throw new RangeError("The decimal count has to be 2 or 3!");if(-1===[".",",","Ù«"].indexOf(t))throw new RangeError(['"',t,'" is not a typical decimal seperator'].join(""));this.decimalCount=i,this.thousandsSeperator=e,this.decimalSeperator=t}function i(e,i){var n,o,r,e=e+"";if(!t.isInt(i))throw new TypeError("Parameter size has to be an Int!");for(n=Math.ceil(e.length/i),o=e.length%i||i,r=new Array(n);--n>0;)r[n]=e.substr((n-1)*i+o,i);return r[0]=e.substr(0,o),r}function n(e){var n;if(!t.isInt(e))throw new TypeError("Parameter int has to be an Int!");return n=parseInt((e+"").slice(0,-1*this.decimalCount)),[i(n,3).join(this.thousandsSeperator),this.decimalSeperator,t.lpad(e%Math.pow(10,this.decimalCount),this.decimalCount)].join("")}return e.prototype={format:n},{create:function(t,i,n){return new e(t,i,n)}}}),function(t,e){"function"==typeof define&&define.amd?define("cestino/Cart",["cestino/Util","cestino/BasicCartService","cestino/PriceFormatter"],e):"object"==typeof module&&module.exports?module.exports=e(require("./Util"),require("./BasicCartService"),require("./PriceFormatter")):t.Cestino=e(t.Cestino.Util,t.Cestino.BasicCartService,t.Cestino.PriceFormatter)}(this,function(t,e,i){"use strict";function n(t){if(t=t||e.create(),"function"!=typeof t.setProductDataToCart)throw new TypeError(["The service has to be able to find Products! ","\n",'Implement a function named "setProductDataToCart" that takes one argument of type ',"Object. ","\n","The keys of the object has to represent product-ids, the ","values has to be arrays of selected product-feature-ids."].join(""));this.positionId=1,this.oCartService=t,this.positions={},this.listener={add:[],remove:[],change:[],load:[]}}function o(t,e,i,n){this.id=t,this.product=e,this.features=i,this.quantity=n,this.cart=null}function r(t){var e=this;return this.getShippingGroups().forEach(function(i){e.getPositionsOfGroup(i).forEach(function(e){t(e,i)})}),this}function s(){var t={date:(new Date).toISOString(),AutoPosId:this.positionId,pos:{}};return this.walk(function(e,i){t.pos[i]=t.pos[i]||[],t.pos[i].push({id:e.id,product:{id:e.product.id},quantity:{amount:e.quantity.amount,dimX:e.quantity.dimensionX,dimY:e.quantity.dimensionY,dimZ:e.quantity.dimensionZ},features:e.features.map(function(t){return t.id})})}),JSON.stringify(t)}function u(t){var e,i,r,s=this;if(0!==Object.keys(this.positions).length)throw new RangeError("Cart has to be empty when loading from a JSON!");return e=JSON.parse(t),this.positionId=e.AutoPosId,Object.keys(e.pos).forEach(function(t){e.pos[t].forEach(function(e){i=new o(e.id,new n.Product(e.product.id,j,987654321),e.features.map(function(t){return new n.ProductFeature(t,j,987654321)}),new n.ProductQuantity(e.quantity.amount,e.quantity.dimX,e.quantity.dimY,e.quantity.dimZ)),i.cart=s,r="g"+t,s.positions[r]=s.positions[r]||[],s.positions[r].push(i)})}),this.oCartService.setProductDataToCart(this).then(function(){s.listener.load.forEach(function(t){t(s)})}),this}function a(t,e){this.listener[t].forEach(function(t){t(e)})}function c(e,i,r,s){var u,c,s=s||[],d="g"+(r||""),i=i||new n.ProductQuantity(1);if(!(e instanceof n.Product))throw new TypeError("The product has to be a instance of Cart.Product!");if(t.isInt(i)&&(i=new n.ProductQuantity(i)),!(i instanceof n.ProductQuantity))throw new TypeError(["The quantity has to be a instance of Cart.ProductQuantity or a positive ","integer value!"].join(""));return this.positions[d]=this.positions[d]||[],u="p"+this.positionId++,c=new o(u,e,s,i),c.cart=this,this.positions[d].push(c),a.call(this,"add",c),u}function d(t,e){if("function"!=typeof e)throw new TypeError("The passed listener has to be a function!");if(-1===I.indexOf(t))throw new TypeError(t+" is an unknown event! Try one of these: "+I.join(", ")+".");return this.listener[t].push(e),this}function h(t,e){var i=this;if(-1===I.indexOf(t))throw new TypeError(t+" is an unknown event! Try one of these: "+I.join(", ")+".");return this.listener[t].some(function(n,o){if(e===n)return i.listener[t].splice(o,1),!0}),this}function f(){return Object.keys(this.positions).map(function(t){return t.substr(1)})}function p(t){var e="g"+(t||"");if(!(e in this.positions))throw new ReferenceError(["No shipping-group with name '",t,"' found!"].join(""));return this.positions[e]}function l(t){var e=0;return this.getPositionsOfGroup(t).forEach(function(t){e+=t.calculate()}),e}function y(){var t=this,e=0;return Object.keys(this.positions).forEach(function(i){e+=t.calculateGroup(i.substr(1))}),e}function m(t){var e,i=P.call(this,t);if(!i)throw new RefereneceError(["No position with id '",t,"' found!"].join(""));return e=this.positions[i.group].splice(i.index,1)[0],a.call(this,"remove",e),e}function w(t){var e=P.call(this,t);if(!e)throw new ReferenceError(["No position with id '",t,"' found!"].join(""));return this.positions[e.group][e.index]}function P(t){var e=this.positions,i=!1;return Object.keys(e).some(function(n){return e[n].some(function(e,o){return e.id===t&&(i={group:n,index:o}),!!i}),!!i}),i}function g(t){if(!(t instanceof n.ProductQuantity))throw new TypeError("The quantity has to be a instance of Cart.ProductQuantity!");return this.quantity=t,a.call(this.cart,"change",this),this}function v(e){if(e=e||1,!t.isInt(e))throw new TypeError("Amount has to be of type integer!");return this.quantity.amount+=e,a.call(this.cart,"change",this),this}function b(e){if(e=e||1,!t.isInt(e))throw new TypeError("Amount has to be of type integer!");return this.quantity.amount-=e,a.call(this.cart,"change",this),this}function E(){var t=0;return this.features.forEach(function(e){t+=e.getPrice()}),(this.product.getPrice()+t)*this.quantity.getFactor()}function C(t){var e,i=this,n=t.prototype;t.prototype=Object.create(this.prototype),t.prototype.constructor=t;for(e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t.prototype[e]=n[e]);return{create:function(){var e=Object.create(t.prototype);return i.apply(e,arguments),t.apply(e,arguments),e}}}function T(t){return function(){return new n[t](void 0!==arguments[0]&&arguments[0]||void 0,void 0!==arguments[1]&&arguments[1]||void 0,void 0!==arguments[2]&&arguments[2]||void 0,void 0!==arguments[3]&&arguments[3]||void 0)}}var j="__INCOMPLETE__",I=["load","add","change","remove"];return n.prototype={add:c,on:d,off:h,calculateGroup:l,calculate:y,deletePosition:m,getPositionsOfGroup:p,getShippingGroups:f,getPositionById:w,toJSON:s,fromJSON:u,walk:r},o.prototype={calculate:E,incrementAmount:v,decrementAmount:b,replaceQuantity:g},n.Product=function(e,i,n){if(t.isEmpty(e)||"string"!=typeof e&&!t.isInt(e))throw new RangeError("The product has to have an id of type string or integer!");if(t.isEmpty(i)||"string"!=typeof i)throw new RangeError("The product has to have a title of type string!");if(!t.isInt(n)||n<0)throw new TypeError("The price has to be an positive integer!");this.id=e,this.title=i,this.price=n},n.Product.prototype.getPrice=function(){return this.price},n.ProductQuantity=function(e,i,n,o){if(this.amount=e,this.dimensionX=i||1,this.dimensionY=n||1,this.dimensionZ=o||1,!(t.isInt(this.amount)&&t.isInt(this.dimensionX)&&t.isInt(this.dimensionY)&&t.isInt(this.dimensionZ)))throw new TypeError(["Invalid try to instanciate quantity. Not all parameters are integers! ","\ndata object: ",JSON.stringify(this),"\n"].join(""))},n.ProductQuantity.prototype.getFactor=function(){return this.amount*this.dimensionX*this.dimensionY*this.dimensionZ},n.ProductFeature=function(e,i,n){if(t.isEmpty(e)||"string"!=typeof e&&!t.isInt(e))throw new RangeError("The product feature has to have an id of type string or integer!");if(t.isEmpty(i)||"string"!=typeof i)throw new RangeError("The product feature has to have a title of type string!");if(!t.isInt(n)||n<0)throw new TypeError("The price has to be an positive integer!");this.id=e,this.price=n,this.label=i},n.ProductFeature.prototype.getPrice=function(){return this.price},{create:function(t){return new n(t)},Util:t,PriceFormatter:i,BasicCartService:e,Product:{create:T("Product"),extendWith:C.bind(n.Product)},ProductFeature:{create:T("ProductFeature"),extendWith:C.bind(n.ProductFeature)},ProductQuantity:{create:T("ProductQuantity"),extendWith:C.bind(n.ProductQuantity)},createProduct:T("Product"),createProductFeature:T("ProductFeature"),createProductQuantity:T("ProductQuantity"),extendProduct:C.bind(n.Product),extendProductFeature:C.bind(n.ProductFeature),extendProductQuantity:C.bind(n.ProductQuantity)}}),"function"==typeof define&&define.amd&&define(["cestino/Cart"],function(t){return t});