!function(t,e){"function"==typeof define&&define.amd?define("cestino/BasicCartService",["bluebird/js/browser/bluebird.min","atomic/dist/atomic.min"],e):"object"==typeof module&&module.exports?module.exports=e(require("bluebird"),require("atomic")):(t.Cestino=t.Cestino||{},t.Cestino.BasicCartService=e(t.Promise,t.atomic))}(this,function(t,e){"use strict";function i(t){var e;this[" options"]=JSON.parse(JSON.stringify(o));for(e in t)this[" options"][e]=t[e]}function n(t,e){e.walk(function(i){var n,r,o=[];if(!(i.getProduct().getId()in t))return void e.deletePosition(i.getId());n=t[i.getProduct().getId()],i.getProduct()[" title"]=n.title,i.getProduct()[" price"]=n.price,i.getFeatures().forEach(function(t,e){if(!(t.getId()in n.features))return void o.push(e);t[" label"]=n.features[t.getId()].label,t[" price"]=n.features[t.getId()].price}),r=o.pop();for(;r;)i[" features"].splice(r,1)[0],r=o.pop()})}function r(i){var r=this,o={};return i.walk(function(t){o[t.getProduct().getId()]=t.getFeatures().map(function(t){return t.getId()})}),new t(function(t,s){e(r[" options"].url,{method:"POST",data:o}).catch(s).then(function(e){n.call(r,e.data,i),t(e.data)})})}var o={url:""};return"undefined"!=typeof window&&(window.Promise=window.Promise||t),i.prototype={setProductDataToCart:r},{create:function(t){return new i(t)}}}),function(t,e){"function"==typeof define&&define.amd?define("cestino/Util",e):"object"==typeof module&&module.exports?module.exports=e():(t.Cestino=t.Cestino||{},t.Cestino.Util=e())}(this,function(){"use strict";function t(t){return t===+t&&t===(0|t)}function e(t){return!t||"0"===t}function i(e,i,n){var r;if(!t(i))throw new TypeError("Parameter width has to be an int!");return e+="",e.length>=i?e:(n=n||"0",n+="",r=new Array(Math.ceil((i-e.length)/n.length)+1).join(n),r.slice(0,i-e.length)+e)}return{isInt:t,isEmpty:e,lpad:i}}),function(t,e){"function"==typeof define&&define.amd?define("cestino/PriceFormatter",["cestino/Util"],e):"object"==typeof module&&module.exports?module.exports=e(require("./Util")):(t.Cestino=t.Cestino||{},t.Cestino.PriceFormatter=e(t.Cestino.Util))}(this,function(t){"use strict";function e(t,e,i){if(i=i||2,e=e||"",-1===[2,3].indexOf(i))throw new RangeError("The decimal count has to be 2 or 3!");if(-1===[".",",","Ù«"].indexOf(t))throw new RangeError(['"',t,'" is not a typical decimal seperator'].join(""));this[" decimalCount"]=i,this[" thousandsSeperator"]=e,this[" decimalSeperator"]=t}function i(e,i){var n,r,o,e=e+"";if(!t.isInt(i))throw new TypeError("Parameter size has to be an Int!");for(n=Math.ceil(e.length/i),r=e.length%i||i,o=new Array(n);--n>0;)o[n]=e.substr((n-1)*i+r,i);return o[0]=e.substr(0,r),o}function n(e){var n;if(!t.isInt(e))throw new TypeError("Parameter int has to be an Int!");return n=parseInt((e+"").slice(0,-1*this[" decimalCount"])),[i(n,3).join(this[" thousandsSeperator"]),this[" decimalSeperator"],t.lpad(e%Math.pow(10,this[" decimalCount"]),this[" decimalCount"])].join("")}return e.prototype={format:n},{create:function(t,i,n){return new e(t,i,n)}}}),function(t,e){"function"==typeof define&&define.amd?define("cestino/Cart",["cestino/Util","cestino/BasicCartService","cestino/PriceFormatter"],e):"object"==typeof module&&module.exports?module.exports=e(require("./Util"),require("./BasicCartService"),require("./PriceFormatter")):t.Cestino=e(t.Cestino.Util,t.Cestino.BasicCartService,t.Cestino.PriceFormatter)}(this,function(t,e,i){"use strict";function n(t){if(t=t||e.create(),"function"!=typeof t.setProductDataToCart)throw new TypeError(["The service has to be able to find Products! ","\n",'Implement a function named "setProductDataToCart" that takes one argument of type ',"Object. ","\n","The keys of the object has to represent product-ids, the ","values has to be arrays of selected product-feature-ids."].join(""));this[" positionId"]=1,this[" oCartService"]=t,this[" positions"]={},this[" shippingGroups"]={},this[" listener"]={add:[],remove:[],change:[],load:[]}}function r(t,e,i,n){this[" id"]=t,this[" product"]=e,this[" features"]=i,this[" quantity"]=n,this[" cart"]=null}function o(t){var e=this;return this.getShippingGroups().forEach(function(i){e.getPositionsOfGroup(i).forEach(function(e){t(e,i)})}),this}function s(){var t={date:(new Date).toISOString(),AutoPosId:this[" positionId"],pos:{}};return this.walk(function(e,i){t.pos[i]=t.pos[i]||[],t.pos[i].push({id:e.getId(),product:{id:e.getProduct().getId()},quantity:{amount:e.getQuantity().getAmount(),dimX:e.getQuantity().getWidth(),dimY:e.getQuantity().getHeight(),dimZ:e.getQuantity().getDepth()},features:e.getFeatures().map(function(t){return t.getId()})})}),JSON.stringify(t)}function u(t){var e,i,o,s,u=this;if(0!==Object.keys(this[" positions"]).length)throw new RangeError("Cart has to be empty when loading from a JSON!");return e=JSON.parse(t),this[" positionId"]=e.AutoPosId,Object.keys(e.pos).forEach(function(t){s="g"+t,o=new n.ShippingGroup(t),o[" cart"]=u,u[" shippingGroups"][s]=o,e.pos[t].forEach(function(t){i=new r(t.id,new n.Product(t.product.id,j,987654321),t.features.map(function(t){return new n.ProductFeature(t,j,987654321)}),new n.ProductQuantity(t.quantity.amount,t.quantity.dimX,t.quantity.dimY,t.quantity.dimZ)),i[" cart"]=u,u[" positions"][s]=u[" positions"][s]||[],u[" positions"][s].push(i)})}),this[" oCartService"].setProductDataToCart(this).then(function(){u[" listener"].load.forEach(function(t){t(u)})}),this}function a(t,e){this[" listener"][t].forEach(function(t){t(e)})}function c(e,i,o,s){var u,c,i=i||new n.ProductQuantity(1),o=d.call(this,o)||new n.ShippingGroup(o),p="g"+o.getName(),s=s||[];if(!(e instanceof n.Product))throw new TypeError("The product has to be a instance of Cart.Product!");if(t.isInt(i)&&(i=new n.ProductQuantity(i)),!(i instanceof n.ProductQuantity))throw new TypeError(["The quantity has to be a instance of Cart.ProductQuantity or a positive ","integer value!"].join(""));return o[" cart"]=this,this[" shippingGroups"][p]=o,this[" positions"][p]=this[" positions"][p]||[],u="p"+this[" positionId"]++,c=new r(u,e,s,i),c[" cart"]=this,this[" positions"][p].push(c),a.call(this,"add",c),u}function p(t,e){if("function"!=typeof e)throw new TypeError("The passed listener has to be a function!");if(-1===G.indexOf(t))throw new TypeError(t+" is an unknown event! Try one of these: "+G.join(", ")+".");return this[" listener"][t].push(e),this}function h(t,e){var i=this;if(-1===G.indexOf(t))throw new TypeError(t+" is an unknown event! Try one of these: "+G.join(", ")+".");return this[" listener"][t].some(function(n,r){if(e===n)return i[" listener"][t].splice(r,1),!0}),this}function f(){return Object.keys(this[" positions"]).map(function(t){return t.substr(1)})}function d(t){var e=t instanceof n.ShippingGroup,i="g"+(e&&t.getName()||t||"");return i in this[" shippingGroups"]&&this[" shippingGroups"][i]||e&&t||!1}function g(t){return"g"+(t instanceof n.ShippingGroup&&t.getName()||t||"")}function l(t){var e=g.call(this,t);if(!(e in this[" positions"]))throw new ReferenceError(["No shipping-group with name '",t,"' found!"].join(""));return this[" positions"][e]}function y(t,e){var i=0,e=e||!1,n=g.call(this,t);return this.getPositionsOfGroup(t).forEach(function(t){i+=t.calculate()}),i+(e&&this[" shippingGroups"][n].getPrice()||0)}function m(t){var e=this,i=0,t=t||!1;return f.call(this).forEach(function(n){i+=y.call(e,n,t)}),i}function w(t){var e,i=v.call(this,t);if(!i)throw new RefereneceError(["No position with id '",t,"' found!"].join(""));return e=this[" positions"][i.group].splice(i.index,1)[0],a.call(this,"remove",e),e}function P(t){var e=v.call(this,t);if(!e)throw new ReferenceError(["No position with id '",t,"' found!"].join(""));return this[" positions"][e.group][e.index]}function v(t){var e=this[" positions"],i=!1;return Object.keys(e).some(function(n){return e[n].some(function(e,r){return e.getId()===t&&(i={group:n,index:r}),!!i}),!!i}),i}function b(t){if(!(t instanceof n.ProductQuantity))throw new TypeError("The quantity has to be a instance of Cart.ProductQuantity!");return this[" quantity"]=t,a.call(this[" cart"],"change",this),this}function I(e){if(e=e||1,!t.isInt(e))throw new TypeError("Amount has to be of type integer!");return this[" quantity"][" amount"]+=e,a.call(this[" cart"],"change",this),this}function E(e){if(e=e||1,!t.isInt(e))throw new TypeError("Amount has to be of type integer!");return this[" quantity"][" amount"]-=e,a.call(this[" cart"],"change",this),this}function C(){var t=0;return this[" features"].forEach(function(e){t+=e.getPrice()}),(this[" product"].getPrice()+t)*this[" quantity"].getFactor()}function S(t){var e,i=this,n=t.prototype;t.prototype=Object.create(this.prototype),t.prototype.constructor=t,t.prototype.getSuperMethod=function(t){return this.__proto__.__proto__.bind(this)};for(e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t.prototype[e]=n[e]);return{create:function(){var e=Object.create(t.prototype);return i.apply(e,arguments),t.apply(e,arguments),e}}}function T(t){return function(){return new n[t](void 0!==arguments[0]&&arguments[0]||void 0,void 0!==arguments[1]&&arguments[1]||void 0,void 0!==arguments[2]&&arguments[2]||void 0,void 0!==arguments[3]&&arguments[3]||void 0)}}var j="__INCOMPLETE__",G=["load","add","change","remove"];return n.prototype={add:c,on:p,off:h,calculateGroup:y,calculate:m,deletePosition:w,getShippingGroupByName:d,getPositionsOfGroup:l,getShippingGroups:f,getPositionById:P,toJSON:s,fromJSON:u,walk:o},r.prototype={calculate:C,incrementAmount:I,decrementAmount:E,replaceQuantity:b},r.prototype.getId=function(){return this[" id"]},r.prototype.getProduct=function(){return this[" product"]},r.prototype.getFeatures=function(){return this[" features"]},r.prototype.getQuantity=function(){return this[" quantity"]},r.prototype.getCart=function(){return this[" cart"]},n.Product=function(e,i,n){if(t.isEmpty(e)||"string"!=typeof e&&!t.isInt(e))throw new RangeError("The product has to have an id of type string or integer!");if(t.isEmpty(i)||"string"!=typeof i)throw new RangeError("The product has to have a title of type string!");if(!t.isInt(n)||n<0)throw new TypeError("The price has to be an positive integer!");this[" id"]=e,this[" title"]=i,this[" price"]=n},n.Product.prototype.getId=function(){return this[" id"]},n.Product.prototype.getTitle=function(){return this[" title"]},n.Product.prototype.getPrice=function(){return this[" price"]},n.ProductQuantity=function(e,i,n,r){if(this[" amount"]=e,this[" dimensionX"]=i||1,this[" dimensionY"]=n||1,this[" dimensionZ"]=r||1,!(t.isInt(this[" amount"])&&t.isInt(this[" dimensionX"])&&t.isInt(this[" dimensionY"])&&t.isInt(this[" dimensionZ"])))throw new TypeError(["Invalid try to instanciate quantity. Not all parameters are integers! ","\ndata object: ",JSON.stringify(this),"\n"].join(""))},n.ProductQuantity.prototype.getAmount=function(){return this[" amount"]},n.ProductQuantity.prototype.getLength=function(){return this[" dimensionX"]},n.ProductQuantity.prototype.getWidth=function(){return this[" dimensionX"]},n.ProductQuantity.prototype.getHeight=function(){return this[" dimensionY"]},n.ProductQuantity.prototype.getDepth=function(){return this[" dimensionZ"]},n.ProductQuantity.prototype.getFactor=function(){return this.getAmount()*this.getWidth()*this.getHeight()*this.getDepth()},n.ProductFeature=function(e,i,n){if(n=n||0,t.isEmpty(e)||"string"!=typeof e&&!t.isInt(e))throw new RangeError("The product feature has to have an id of type string or integer!");if(t.isEmpty(i)||"string"!=typeof i)throw new RangeError("The product feature has to have a title of type string!");if(!t.isInt(n)||n<0)throw new TypeError("The price has to be an positive integer!");this[" id"]=e,this[" price"]=n,this[" label"]=i},n.ProductFeature.prototype.getId=function(){return this[" id"]},n.ProductFeature.prototype.getPrice=function(){return this[" price"]},n.ProductFeature.prototype.getLabel=function(){return this[" label"]},n.ShippingGroup=function(t){this[" name"]=t||"",this[" cart"]=null,this[" price"]=0},n.ShippingGroup.prototype.calculate=function(){return y.call(this.getCart(),this.getName(),includeShippingGroupCost||!0)},n.ShippingGroup.prototype.setPrice=function(e){if(!t.isInt(e)||e<0)throw new TypeError("The price has to be an positive integer!");return this[" price"]=e,this},n.ShippingGroup.prototype.getPrice=function(){return this[" price"]},n.ShippingGroup.prototype.getName=function(){return this[" name"]},n.ShippingGroup.prototype.getCart=function(){return this[" cart"]},{create:function(t){return new n(t)},Util:t,PriceFormatter:i,BasicCartService:e,Product:{create:T("Product"),extendWith:S.bind(n.Product)},ProductFeature:{create:T("ProductFeature"),extendWith:S.bind(n.ProductFeature)},ProductQuantity:{create:T("ProductQuantity"),extendWith:S.bind(n.ProductQuantity)},ShippingGroup:{create:T("ShippingGroup"),extendWith:S.bind(n.ShippingGroup)}}}),"function"==typeof define&&define.amd&&define(["cestino/Cart"],function(t){return t});