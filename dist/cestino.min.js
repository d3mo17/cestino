!function(t,e){"function"==typeof define&&define.amd?define("cestino/BasicCartService",["bluebird/js/browser/bluebird.core.min","atomic/dist/atomic.min"],e):"object"==typeof module&&module.exports?module.exports=e(require("bluebird/js/browser/bluebird.core.min"),require("atomic/dist/atomic.min")):(t.Cestino=t.Cestino||{},t.Cestino.BasicCartService=e(t.Promise,t.Atomic))}(this,function(t,e){"use strict";function i(t){var e;this.options=JSON.parse(JSON.stringify(r));for(e in t)this.options[e]=t[e]}function n(t,e){e.walk(function(i){var n,o,r=[];if(!(i.product.id in t))return void e.deletePosition(i.id);n=t[i.product.id],i.product.title=n.title,i.product.price=n.price,i.features.forEach(function(t,e){if(!(t.id in n.features))return void r.push(e);t.label=n.features[t.id].label,t.price=n.features[t.id].price}),o=r.pop();for(;o;)i.features.splice(o,1)[0],o=r.pop()})}function o(i){var o=this,r={};return i.walk(function(t){r[t.product.id]=t.features.map(function(t){return t.id})}),new t(function(t,s){e.setContentType("application/json"),e.post(o.options.url,{query:r}).error(s).success(function(e){n.call(o,e,i),t(e)})})}var r={url:""};return i.prototype={getProductBasics:o},{create:function(t){return new i(t)}}}),function(t,e){"function"==typeof define&&define.amd?define("cestino/Util",e):"object"==typeof module&&module.exports?module.exports=e():(t.Cestino=t.Cestino||{},t.Cestino.Util=e())}(this,function(){"use strict";function t(t){return t===+t&&t===(0|t)}function e(t){return!t||"0"===t}function i(e,i,n){var o;if(!t(i))throw new TypeError("Parameter width has to be an int!");return e+="",e.length>=i?e:(n=n||"0",n+="",o=new Array(Math.ceil((i-e.length)/n.length)+1).join(n),o.slice(0,i-e.length)+e)}return{isInt:t,isEmpty:e,lpad:i}}),function(t,e){var i,n;if("function"==typeof define&&define.amd)define("cestino/Cart",["cestino/Util","cestino/BasicCartService"],function(i){return e(i,t)});else if("object"==typeof module&&module.exports)module.exports=e(require("cestino/Util"),t);else{n=t.Cestino,t.Cestino=e(n.Util,t);for(i in n)n.hasOwnProperty(i)&&(t.Cestino[i]=n[i])}}(this,function(t,e){"use strict";function i(t){if(t=t||"Cestino"in e&&e.Cestino.BasicCartService.create()||require("cestino/BasicCartService").create(),"function"!=typeof t.getProductBasics)throw new TypeError(["The service has to be able to find Products! ","\n",'Implement a function named "getProductBasics" that takes one argument of type ',"Object. ","\n","The keys of the object has to represent product-ids, the ","values has to be arrays of selected product-feature-ids."].join(""));this.positionId=1,this.oCartService=t,this.positions={},this.listener={add:[],remove:[],change:[],load:[]}}function n(t){var e=this;return this.getShippingGroups().forEach(function(i){e.getPositionsOfGroup(i).forEach(function(e){t(e,i)})}),this}function o(){var t={date:(new Date).toISOString(),AutoPosId:this.positionId,pos:{}};return this.walk(function(e,i){t.pos[i]=t.pos[i]||[],t.pos[i].push({id:e.id,product:{id:e.product.id},quantity:{amount:e.quantity.amount,dimX:e.quantity.dimensionX,dimY:e.quantity.dimensionY,dimZ:e.quantity.dimensionZ},features:e.features.map(function(t){return t.id})})}),JSON.stringify(t)}function r(t){var e,n,o,r=this;if(0!==Object.keys(this.positions).length)throw new RangeError("Cart has to be empty when loading from a JSON!");return e=JSON.parse(t),this.positionId=e.AutoPosId,Object.keys(e.pos).forEach(function(t){e.pos[t].forEach(function(e){n=new w(e.id,new i.Product(e.product.id,E,987654321),e.features.map(function(t){return new i.ProductFeature(t,E,987654321)}),new i.ProductQuantity(e.quantity.amount,e.quantity.dimX,e.quantity.dimY,e.quantity.dimZ)),n.cart=r,o="g"+t,r.positions[o]=r.positions[o]||[],r.positions[o].push(n)})}),this.oCartService.getProductBasics(this).then(function(){r.listener.load.forEach(function(t){t(r)})}),this}function s(t,e){this.listener[t].forEach(function(t){t(e)})}function u(e,n,o,r){var u,a,r=r||[],c="g"+(o||""),n=n||new i.ProductQuantity(1);if(!(e instanceof i.Product))throw new TypeError("The product has to be a instance of Cart.Product!");if(t.isInt(n)&&(n=new i.ProductQuantity(n)),!(n instanceof i.ProductQuantity))throw new TypeError(["The quantity has to be a instance of Cart.ProductQuantity or a positive ","integer value!"].join(""));return this.positions[c]=this.positions[c]||[],u="p"+this.positionId++,a=new w(u,e,r,n),a.cart=this,this.positions[c].push(a),s.call(this,"add",a),u}function a(t,e){if("function"!=typeof e)throw new TypeError("The passed listener has to be a function!");if(-1===C.indexOf(t))throw new TypeError(t+" is an unknown event! Try one of these: "+C.join(", ")+".");return this.listener[t].push(e),this}function c(t,e){var i=this;if(-1===C.indexOf(t))throw new TypeError(t+" is an unknown event! Try one of these: "+C.join(", ")+".");return this.listener[t].some(function(n,o){if(e===n)return i.listener[t].splice(o,1),!0}),this}function f(){return Object.keys(this.positions).map(function(t){return t.substr(1)})}function h(t){var e="g"+(t||"");if(!(e in this.positions))throw new ReferenceError(["No shipping-group with name '",t,"' found!"].join(""));return this.positions[e]}function d(t){var e=0;return this.getPositionsOfGroup(t).forEach(function(t){e+=t.calculate()}),e}function p(){var t=this,e=0;return Object.keys(this.positions).forEach(function(i){e+=t.calculateGroup(i.substr(1))}),e}function l(t){var e,i=y.call(this,t);if(!i)throw new RefereneceError(["No position with id '",t,"' found!"].join(""));return e=this.positions[i.group].splice(i.index,1)[0],s.call(this,"remove",e),e}function m(t){var e=y.call(this,t);if(!e)throw new ReferenceError(["No position with id '",t,"' found!"].join(""));return this.positions[e.group][e.index]}function y(t){var e=this.positions,i=!1;return Object.keys(e).some(function(n){return e[n].some(function(e,o){return e.id===t&&(i={group:n,index:o}),!!i}),!!i}),i}function w(t,e,i,n){this.id=t,this.product=e,this.features=i,this.quantity=n,this.cart=null}function g(t){if(!(t instanceof i.ProductQuantity))throw new TypeError("The quantity has to be a instance of Cart.ProductQuantity!");return this.quantity=t,s.call(this.cart,"change",this),this}function v(e){if(e=e||1,!t.isInt(e))throw new TypeError("Amount has to be of type integer!");return this.quantity.amount+=e,s.call(this.cart,"change",this),this}function b(e){if(e=e||1,!t.isInt(e))throw new TypeError("Amount has to be of type integer!");return this.quantity.amount-=e,s.call(this.cart,"change",this),this}function P(){var t=0;return this.features.forEach(function(e){t+=e.price}),(this.product.price+t)*this.quantity.getFactor()}var E="__INCOMPLETE__",C=["load","add","change","remove"];return i.prototype={add:u,on:a,off:c,calculateGroup:d,calculate:p,deletePosition:l,getPositionsOfGroup:h,getShippingGroups:f,getPositionById:m,toJSON:o,fromJSON:r,walk:n},i.Product=function(e,i,n){if(t.isEmpty(e)||"string"!=typeof e&&!t.isInt(e))throw new RangeError("The product has to have an id of type string oe integer!");if(t.isEmpty(i)||"string"!=typeof i)throw new RangeError("The product has to have a title of type string!");if(!t.isInt(n)||n<0)throw new TypeError("The price has to be an positive integer!");this.id=e,this.title=i,this.price=n},i.ProductQuantity=function(e,i,n,o){if(this.amount=e,this.dimensionX=i||1,this.dimensionY=n||1,this.dimensionZ=o||1,!(t.isInt(this.amount)&&t.isInt(this.dimensionX)&&t.isInt(this.dimensionY)&&t.isInt(this.dimensionZ)))throw new TypeError(["Invalid try to instanciate quantity. Not all parameters are integers! ","\ndata object: ",JSON.stringify(this),"\n"].join(""))},i.ProductQuantity.prototype.getFactor=function(){return this.amount*this.dimensionX*this.dimensionY*this.dimensionZ},i.ProductFeature=function(e,i,n){if(t.isEmpty(e)||"string"!=typeof e&&!t.isInt(e))throw new RangeError("The product feature has to have an id of type string oe integer!");if(t.isEmpty(i)||"string"!=typeof i)throw new RangeError("The product feature has to have a title of type string!");if(!t.isInt(n)||n<0)throw new TypeError("The price has to be an positive integer!");this.id=e,this.price=n,this.label=i},w.prototype={calculate:P,incrementAmount:v,decrementAmount:b,replaceQuantity:g},{create:function(t){return new i(t)},createProduct:function(t,e,n){return new i.Product(t,e,n)},createProductFeature:function(t,e,n){return new i.ProductFeature(t,e,n)},createProductQuantity:function(t,e,n,o){return new i.ProductQuantity(t,e,n,o)}}}),function(t,e){"function"==typeof define&&define.amd?define("cestino/PriceFormatter",["cestino/Util"],e):"object"==typeof module&&module.exports?module.exports=e(require("cestino/Util")):(t.Cestino=t.Cestino||{},t.Cestino.PriceFormatter=e(t.Cestino.Util))}(this,function(t){"use strict";function e(t,e,i){if(i=i||2,e=e||"",-1===[2,3].indexOf(i))throw new RangeError("The decimal count has to be 2 or 3!");if(-1===[".",",","Ù«"].indexOf(t))throw new RangeError(['"',t,'" is not a typical decimal seperator'].join(""));this.decimalCount=i,this.thousandsSeperator=e,this.decimalSeperator=t}function i(e,i){var n,o,r,e=e+"";if(!t.isInt(i))throw new TypeError("Parameter size has to be an Int!");for(n=Math.ceil(e.length/i),o=e.length%i||i,r=new Array(n);--n>0;)r[n]=e.substr((n-1)*i+o,i);return r[0]=e.substr(0,o),r}function n(e){var n;if(!t.isInt(e))throw new TypeError("Parameter int has to be an Int!");return n=parseInt((e+"").slice(0,-1*this.decimalCount)),[i(n,3).join(this.thousandsSeperator),this.decimalSeperator,t.lpad(e%Math.pow(10,this.decimalCount),this.decimalCount)].join("")}return e.prototype={format:n},{create:function(t,i,n){return new e(t,i,n)}}}),function(t,e){"function"==typeof define&&define.amd?define(["cestino/Cart","cestino/BasicCartService","cestino/PriceFormatter"],e):"object"==typeof module&&module.exports&&(module.exports=e(require("cestino/Cart")))}(0,function(t){return t});