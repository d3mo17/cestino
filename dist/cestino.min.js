!function(t,i){"function"==typeof define&&define.amd?define("cestino/BasicCartService",["bluebird/js/browser/bluebird.min","atomicjs/dist/atomic.min"],i):"object"==typeof module&&module.exports?module.exports=i(require("bluebird"),require("atomicjs")):(t.Cestino=t.Cestino||{},t.Cestino.BasicCartService=i(t.Promise,t.atomic))}(this,function(t,i){"use strict";function e(t){var i;this.options=JSON.parse(JSON.stringify(o));for(i in t)this.options[i]=t[i]}function n(t,i){i.walk(function(e){var n,r,o=[];if(!(e.product.id in t))return void i.deletePosition(e.id);n=t[e.product.id],e.product.title=n.title,e.product.price=n.price,e.features.forEach(function(t,i){if(!(t.id in n.features))return void o.push(i);t.label=n.features[t.id].label,t.price=n.features[t.id].price}),r=o.pop();for(;r;)e.features.splice(r,1)[0],r=o.pop()})}function r(e){var r=this,o={};return e.walk(function(t){o[t.product.id]=t.features.map(function(t){return t.id})}),new t(function(t,s){i.ajax({url:r.options.url,type:"POST",data:o}).error(s).success(function(i){n.call(r,i,e),t(i)})})}var o={url:""};return e.prototype={setProductDataToCart:r},{create:function(t){return new e(t)}}}),function(t,i){"function"==typeof define&&define.amd?define("cestino/Util",i):"object"==typeof module&&module.exports?module.exports=i():(t.Cestino=t.Cestino||{},t.Cestino.Util=i())}(this,function(){"use strict";function t(t){return t===+t&&t===(0|t)}function i(t){return!t||"0"===t}function e(i,e,n){var r;if(!t(e))throw new TypeError("Parameter width has to be an int!");return i+="",i.length>=e?i:(n=n||"0",n+="",r=new Array(Math.ceil((e-i.length)/n.length)+1).join(n),r.slice(0,e-i.length)+i)}return{isInt:t,isEmpty:i,lpad:e}}),function(t,i){"function"==typeof define&&define.amd?define("cestino/PriceFormatter",["cestino/Util"],i):"object"==typeof module&&module.exports?module.exports=i(require("./Util")):(t.Cestino=t.Cestino||{},t.Cestino.PriceFormatter=i(t.Cestino.Util))}(this,function(t){"use strict";function i(t,i,e){if(e=e||2,i=i||"",-1===[2,3].indexOf(e))throw new RangeError("The decimal count has to be 2 or 3!");if(-1===[".",",","Ù«"].indexOf(t))throw new RangeError(['"',t,'" is not a typical decimal seperator'].join(""));this.decimalCount=e,this.thousandsSeperator=i,this.decimalSeperator=t}function e(i,e){var n,r,o,i=i+"";if(!t.isInt(e))throw new TypeError("Parameter size has to be an Int!");for(n=Math.ceil(i.length/e),r=i.length%e||e,o=new Array(n);--n>0;)o[n]=i.substr((n-1)*e+r,e);return o[0]=i.substr(0,r),o}function n(i){var n;if(!t.isInt(i))throw new TypeError("Parameter int has to be an Int!");return n=parseInt((i+"").slice(0,-1*this.decimalCount)),[e(n,3).join(this.thousandsSeperator),this.decimalSeperator,t.lpad(i%Math.pow(10,this.decimalCount),this.decimalCount)].join("")}return i.prototype={format:n},{create:function(t,e,n){return new i(t,e,n)}}}),function(t,i){"function"==typeof define&&define.amd?define("cestino/Cart",["cestino/Util","cestino/BasicCartService","cestino/PriceFormatter"],i):"object"==typeof module&&module.exports?module.exports=i(require("./Util"),require("./BasicCartService"),require("./PriceFormatter")):t.Cestino=i(t.Cestino.Util,t.Cestino.BasicCartService,t.Cestino.PriceFormatter)}(this,function(t,i,e){"use strict";function n(t){if(t=t||i.create(),"function"!=typeof t.setProductDataToCart)throw new TypeError(["The service has to be able to find Products! ","\n",'Implement a function named "setProductDataToCart" that takes one argument of type ',"Object. ","\n","The keys of the object has to represent product-ids, the ","values has to be arrays of selected product-feature-ids."].join(""));this.positionId=1,this.oCartService=t,this.positions={},this[" shippingGroups"]={},this.listener={add:[],remove:[],change:[],load:[]}}function r(t,i,e,n){this.id=t,this.product=i,this.features=e,this.quantity=n,this.cart=null}function o(t){var i=this;return this.getShippingGroups().forEach(function(e){i.getPositionsOfGroup(e).forEach(function(i){t(i,e)})}),this}function s(){var t={date:(new Date).toISOString(),AutoPosId:this.positionId,pos:{}};return this.walk(function(i,e){t.pos[e]=t.pos[e]||[],t.pos[e].push({id:i.id,product:{id:i.product.id},quantity:{amount:i.quantity.amount,dimX:i.quantity.dimensionX,dimY:i.quantity.dimensionY,dimZ:i.quantity.dimensionZ},features:i.features.map(function(t){return t.id})})}),JSON.stringify(t)}function u(t){var i,e,o,s,u=this;if(0!==Object.keys(this.positions).length)throw new RangeError("Cart has to be empty when loading from a JSON!");return i=JSON.parse(t),this.positionId=i.AutoPosId,Object.keys(i.pos).forEach(function(t){s="g"+t,o=new n.ShippingGroup(t),o[" cart"]=u,u[" shippingGroups"][s]=o,i.pos[t].forEach(function(t){e=new r(t.id,new n.Product(t.product.id,I,987654321),t.features.map(function(t){return new n.ProductFeature(t,I,987654321)}),new n.ProductQuantity(t.quantity.amount,t.quantity.dimX,t.quantity.dimY,t.quantity.dimZ)),e.cart=u,u.positions[s]=u.positions[s]||[],u.positions[s].push(e)})}),this.oCartService.setProductDataToCart(this).then(function(){u.listener.load.forEach(function(t){t(u)})}),this}function a(t,i){this.listener[t].forEach(function(t){t(i)})}function c(i,e,o,s){var u,c,e=e||new n.ProductQuantity(1),o=d.call(this,o)||new n.ShippingGroup(o),p="g"+o.getName(),s=s||[];if(!(i instanceof n.Product))throw new TypeError("The product has to be a instance of Cart.Product!");if(t.isInt(e)&&(e=new n.ProductQuantity(e)),!(e instanceof n.ProductQuantity))throw new TypeError(["The quantity has to be a instance of Cart.ProductQuantity or a positive ","integer value!"].join(""));return o[" cart"]=this,this[" shippingGroups"][p]=o,this.positions[p]=this.positions[p]||[],u="p"+this.positionId++,c=new r(u,i,s,e),c.cart=this,this.positions[p].push(c),a.call(this,"add",c),u}function p(t,i){if("function"!=typeof i)throw new TypeError("The passed listener has to be a function!");if(-1===G.indexOf(t))throw new TypeError(t+" is an unknown event! Try one of these: "+G.join(", ")+".");return this.listener[t].push(i),this}function h(t,i){var e=this;if(-1===G.indexOf(t))throw new TypeError(t+" is an unknown event! Try one of these: "+G.join(", ")+".");return this.listener[t].some(function(n,r){if(i===n)return e.listener[t].splice(r,1),!0}),this}function f(){return Object.keys(this.positions).map(function(t){return t.substr(1)})}function d(t){var i=t instanceof n.ShippingGroup,e="g"+(i&&t.getName()||t||"");return e in this[" shippingGroups"]&&this[" shippingGroups"][e]||i&&t||!1}function l(t){return"g"+(t instanceof n.ShippingGroup&&t.getName()||t||"")}function y(t){var i=l.call(this,t);if(!(i in this.positions))throw new ReferenceError(["No shipping-group with name '",t,"' found!"].join(""));return this.positions[i]}function m(t,i){var e=0,i=i||!1,n=l.call(this,t);return this.getPositionsOfGroup(t).forEach(function(t){e+=t.calculate()}),e+(i&&this[" shippingGroups"][n].getPrice()||0)}function g(t){var i=this,e=0,t=t||!1;return f.call(this).forEach(function(n){e+=m.call(i,n,t)}),e}function w(t){var i,e=v.call(this,t);if(!e)throw new RefereneceError(["No position with id '",t,"' found!"].join(""));return i=this.positions[e.group].splice(e.index,1)[0],a.call(this,"remove",i),i}function P(t){var i=v.call(this,t);if(!i)throw new ReferenceError(["No position with id '",t,"' found!"].join(""));return this.positions[i.group][i.index]}function v(t){var i=this.positions,e=!1;return Object.keys(i).some(function(n){return i[n].some(function(i,r){return i.id===t&&(e={group:n,index:r}),!!e}),!!e}),e}function b(t){if(!(t instanceof n.ProductQuantity))throw new TypeError("The quantity has to be a instance of Cart.ProductQuantity!");return this.quantity=t,a.call(this.cart,"change",this),this}function E(i){if(i=i||1,!t.isInt(i))throw new TypeError("Amount has to be of type integer!");return this.quantity.amount+=i,a.call(this.cart,"change",this),this}function C(i){if(i=i||1,!t.isInt(i))throw new TypeError("Amount has to be of type integer!");return this.quantity.amount-=i,a.call(this.cart,"change",this),this}function S(){var t=0;return this.features.forEach(function(i){t+=i.getPrice()}),(this.product.getPrice()+t)*this.quantity.getFactor()}function T(t){var i,e=this,n=t.prototype;t.prototype=Object.create(this.prototype),t.prototype.constructor=t;for(i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t.prototype[i]=n[i]);return{create:function(){var i=Object.create(t.prototype);return e.apply(i,arguments),t.apply(i,arguments),i}}}function j(t){return function(){return new n[t](void 0!==arguments[0]&&arguments[0]||void 0,void 0!==arguments[1]&&arguments[1]||void 0,void 0!==arguments[2]&&arguments[2]||void 0,void 0!==arguments[3]&&arguments[3]||void 0)}}var I="__INCOMPLETE__",G=["load","add","change","remove"];return n.prototype={add:c,on:p,off:h,calculateGroup:m,calculate:g,deletePosition:w,getShippingGroupByName:d,getPositionsOfGroup:y,getShippingGroups:f,getPositionById:P,toJSON:s,fromJSON:u,walk:o},r.prototype={calculate:S,incrementAmount:E,decrementAmount:C,replaceQuantity:b},n.Product=function(i,e,n){if(t.isEmpty(i)||"string"!=typeof i&&!t.isInt(i))throw new RangeError("The product has to have an id of type string or integer!");if(t.isEmpty(e)||"string"!=typeof e)throw new RangeError("The product has to have a title of type string!");if(!t.isInt(n)||n<0)throw new TypeError("The price has to be an positive integer!");this.id=i,this.title=e,this.price=n},n.Product.prototype.getPrice=function(){return this.price},n.ProductQuantity=function(i,e,n,r){if(this.amount=i,this.dimensionX=e||1,this.dimensionY=n||1,this.dimensionZ=r||1,!(t.isInt(this.amount)&&t.isInt(this.dimensionX)&&t.isInt(this.dimensionY)&&t.isInt(this.dimensionZ)))throw new TypeError(["Invalid try to instanciate quantity. Not all parameters are integers! ","\ndata object: ",JSON.stringify(this),"\n"].join(""))},n.ProductQuantity.prototype.getFactor=function(){return this.amount*this.dimensionX*this.dimensionY*this.dimensionZ},n.ProductFeature=function(i,e,n){if(t.isEmpty(i)||"string"!=typeof i&&!t.isInt(i))throw new RangeError("The product feature has to have an id of type string or integer!");if(t.isEmpty(e)||"string"!=typeof e)throw new RangeError("The product feature has to have a title of type string!");if(!t.isInt(n)||n<0)throw new TypeError("The price has to be an positive integer!");this.id=i,this.price=n,this.label=e},n.ProductFeature.prototype.getPrice=function(){return this.price},n.ShippingGroup=function(t){this[" name"]=t||"",this[" cart"]=null,this[" price"]=0},n.ShippingGroup.prototype.calculate=function(){return m.call(this.getCart(),this.getName(),includeShippingGroupCost||!0)},n.ShippingGroup.prototype.setPrice=function(i){if(!t.isInt(i)||i<0)throw new TypeError("The price has to be an positive integer!");return this[" price"]=i,this},n.ShippingGroup.prototype.getPrice=function(){return this[" price"]},n.ShippingGroup.prototype.getName=function(){return this[" name"]},n.ShippingGroup.prototype.getCart=function(){return this[" cart"]},{create:function(t){return new n(t)},Util:t,PriceFormatter:e,BasicCartService:i,Product:{create:j("Product"),extendWith:T.bind(n.Product)},ProductFeature:{create:j("ProductFeature"),extendWith:T.bind(n.ProductFeature)},ProductQuantity:{create:j("ProductQuantity"),extendWith:T.bind(n.ProductQuantity)},ShippingGroup:{create:j("ShippingGroup"),extendWith:T.bind(n.ShippingGroup)},createProduct:j("Product"),createProductFeature:j("ProductFeature"),createProductQuantity:j("ProductQuantity"),extendProduct:T.bind(n.Product),extendProductFeature:T.bind(n.ProductFeature),extendProductQuantity:T.bind(n.ProductQuantity)}}),"function"==typeof define&&define.amd&&define(["cestino/Cart"],function(t){return t});