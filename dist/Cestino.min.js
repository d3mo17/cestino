!function(t,i){"function"==typeof define&&define.amd?define("cestino/BasicCartService",["bluebird/js/browser/bluebird.core.min","atomic/dist/atomic.min"],i):"object"==typeof module&&module.exports?module.exports=i(require("bluebird/js/browser/bluebird.core.min"),require("atomic/dist/atomic.min")):t.Cestino.BasicCartService=i(t.Promise,t.Atomic)}(this,function(t,i){"use strict";function e(t){var i;this.options=JSON.parse(JSON.stringify(r));for(i in t)this.options[i]=t[i]}function n(t,i){i.walk(function(e){var n,o,r=[];if(!(e.product.id in t))return void i.deletePosition(e.id);n=t[e.product.id],e.product.title=n.title,e.product.price=n.price,e.features.forEach(function(t,i){return t.id in n.features?(t.label=n.features[t.id].label,void(t.price=n.features[t.id].price)):void r.push(i)}),o=r.pop();for(;o;)e.features.splice(o,1)[0],o=r.pop()})}function o(e){var o=this,r={};return e.walk(function(t){r[t.product.id]=t.features.map(function(t){return t.id})}),new t(function(t,s){i.setContentType("application/json"),i.post(o.options.url,{query:r}).error(s).success(function(i){n.call(o,i,e),t(i)})})}var r={url:""};return e.prototype={getProductBasics:o},{create:function(t){return new e(t)}}}),function(t,i){"function"==typeof define&&define.amd?define("cestino/Util",i):"object"==typeof module&&module.exports?module.exports=i():(t.Cestino=t.Cestino||{},t.Cestino.Util=i())}(this,function(){"use strict";function t(t){return t===+t&&t===(0|t)}function i(t){return!t||t===!1}function e(i,e,n){var o;if(!t(e))throw new TypeError("Parameter width has to be an int!");return i+="",i.length>=e?i:(n=n||"0",n+="",o=new Array(Math.ceil((e-i.length)/n.length)+1).join(n),o.slice(0,e-i.length)+i)}return{isInt:t,isEmpty:i,lpad:e}}),function(t,i){var e;"function"==typeof define&&define.amd?define("cestino/Cart",["cestino/Util","cestino/BasicCartService"],function(e){return i(e,t)}):"object"==typeof module&&module.exports?module.exports=i(require("cestino/Util"),t):(e=t.Cestino.Util,t.Cestino=i(e,t),t.Cestino.Util=e)}(this,function(t,i){"use strict";function e(t){if(t=t||"Cestino"in i&&i.Cestino.BasicCartService.create()||require("cestino/BasicCartService").create(),"function"!=typeof t.getProductBasics)throw new TypeError(["The service has to be able to find Products! ","\n",'Implement a function named "getProductBasics" that takes one argument of type ',"Object. ","\n","The keys of the object has to represent product-ids, the ","values has to be arrays of selected product-feature-ids."].join(""));this.positionId=1,this.oCartService=t,this.positions={},this.listener={add:[],remove:[],change:[],load:[]}}function n(t){var i=this;return this.getShippingGroups().forEach(function(e){i.getPositionsOfGroup(e).forEach(function(i){t(i,e)})}),this}function o(){var t={date:(new Date).toISOString(),AutoPosId:this.positionId,pos:{}};return this.walk(function(i,e){t.pos[e]=t.pos[e]||[],t.pos[e].push({id:i.id,product:{id:i.product.id},quantity:{amount:i.quantity.amount,dimX:i.quantity.dimensionX,dimY:i.quantity.dimensionY,dimZ:i.quantity.dimensionZ},features:i.features.map(function(t){return t.id})})}),JSON.stringify(t)}function r(t){var i,n,o,r=this;if(0!==Object.keys(this.positions).length)throw new RangeError("Cart has to be empty when loading from a JSON!");return i=JSON.parse(t),this.positionId=i.AutoPosId,Object.keys(i.pos).forEach(function(t){i.pos[t].forEach(function(i){n=new w(i.id,new e.Product(i.product.id,P,987654321),i.features.map(function(t){return new e.ProductFeature(t,P,987654321)}),new e.ProductQuantity(i.quantity.amount,i.quantity.dimX,i.quantity.dimY,i.quantity.dimZ)),n.cart=r,o="g"+t,r.positions[o]=r.positions[o]||[],r.positions[o].push(n)})}),this.oCartService.getProductBasics(this).then(function(){r.listener.load.forEach(function(t){t(r)})}),this}function s(t,i){this.listener[t].forEach(function(t){t(i)})}function u(i,n,o,r){var u,a,r=r||[],c="g"+(o||""),n=n||new e.ProductQuantity(1);if(!(i instanceof e.Product))throw new TypeError("The product has to be a instance of Cart.Product!");if(t.isInt(n)&&(n=new e.ProductQuantity(n)),!(n instanceof e.ProductQuantity))throw new TypeError(["The quantity has to be a instance of Cart.ProductQuantity or a positive ","integer value!"].join(""));return this.positions[c]=this.positions[c]||[],u="p"+this.positionId++,a=new w(u,i,r,n),a.cart=this,this.positions[c].push(a),s.call(this,"add",a),u}function a(t,i){if("function"!=typeof i)throw new TypeError("The passed listener has to be a function!");if(-1===T.indexOf(t))throw new TypeError(t+" is an unknown event! Try one of these: "+T.join(", ")+".");return this.listener[t].push(i),this}function c(t,i){var e=this;if(-1===T.indexOf(t))throw new TypeError(t+" is an unknown event! Try one of these: "+T.join(", ")+".");return this.listener[t].some(function(n,o){return i===n?(e.listener[t].splice(o,1),!0):void 0}),this}function h(){return Object.keys(this.positions).map(function(t){return t.substr(1)})}function f(t){var i="g"+(t||"");if(!(i in this.positions))throw new ReferenceError(["No shipping-group with name '",t,"' found!"].join(""));return this.positions[i]}function d(t){var i=0;return this.getPositionsOfGroup(t).forEach(function(t){i+=t.calculate()}),i}function p(){var t=this,i=0;return Object.keys(this.positions).forEach(function(e){i+=t.calculateGroup(e.substr(1))}),i}function l(t){var i,e=y.call(this,t);if(!e)throw new RefereneceError(["No position with id '",t,"' found!"].join(""));return i=this.positions[e.group].splice(e.index,1)[0],s.call(this,"remove",i),i}function m(t){var i=y.call(this,t);if(!i)throw new ReferenceError(["No position with id '",t,"' found!"].join(""));return this.positions[i.group][i.index]}function y(t){var i=this.positions,e=!1;return Object.keys(i).some(function(n){return i[n].some(function(i,o){return i.id===t&&(e={group:n,index:o}),!!e}),!!e}),e}function w(t,i,e,n){this.id=t,this.product=i,this.features=e,this.quantity=n,this.cart=null}function g(t){if(!(t instanceof e.ProductQuantity))throw new TypeError("The quantity has to be a instance of Cart.ProductQuantity!");return this.quantity=t,s.call(this.cart,"change",this),this}function v(i){if(i=i||1,!t.isInt(i))throw new TypeError("Amount has to be of type integer!");return this.quantity.amount+=i,s.call(this.cart,"change",this),this}function b(i){if(i=i||1,!t.isInt(i))throw new TypeError("Amount has to be of type integer!");return this.quantity.amount-=i,s.call(this.cart,"change",this),this}function E(){var t=0;return this.features.forEach(function(i){t+=i.price}),(this.product.price+t)*this.quantity.getFactor()}var P="__INCOMPLETE__",T=["load","add","change","remove"];return e.prototype={add:u,on:a,off:c,calculateGroup:d,calculate:p,deletePosition:l,getPositionsOfGroup:f,getShippingGroups:h,getPositionById:m,toJSON:o,fromJSON:r,walk:n},e.Product=function(i,e,n){if(t.isEmpty(i)||"string"!=typeof i&&!t.isInt(i))throw new RangeError("The product has to have an id of type string oe integer!");if(t.isEmpty(e)||"string"!=typeof e)throw new RangeError("The product has to have a title of type string!");if(!t.isInt(n)||0>n)throw new TypeError("The price has to be an positive integer!");this.id=i,this.title=e,this.price=n},e.ProductQuantity=function(i,e,n,o){if(this.amount=i,this.dimensionX=e||1,this.dimensionY=n||1,this.dimensionZ=o||1,!(t.isInt(this.amount)&&t.isInt(this.dimensionX)&&t.isInt(this.dimensionY)&&t.isInt(this.dimensionZ)))throw new TypeError(["Invalid try to instanciate quantity. Not all parameters are integers! ","\ndata object: ",JSON.stringify(this),"\n"].join(""))},e.ProductQuantity.prototype.getFactor=function(){return this.amount*this.dimensionX*this.dimensionY*this.dimensionZ},e.ProductFeature=function(i,e,n){if(t.isEmpty(i)||"string"!=typeof i&&!t.isInt(i))throw new RangeError("The product feature has to have an id of type string oe integer!");if(t.isEmpty(e)||"string"!=typeof e)throw new RangeError("The product feature has to have a title of type string!");if(!t.isInt(n)||0>n)throw new TypeError("The price has to be an positive integer!");this.id=i,this.price=n,this.label=e},w.prototype={calculate:E,incrementAmount:v,decrementAmount:b,replaceQuantity:g},{create:function(t){return new e(t)},createProduct:function(t,i,n){return new e.Product(t,i,n)},createProductFeature:function(t,i,n){return new e.ProductFeature(t,i,n)},createProductQuantity:function(t,i,n,o){return new e.ProductQuantity(t,i,n,o)}}}),function(t,i){"function"==typeof define&&define.amd?define("cestino/PriceFormatter",["cestino/Util"],i):"object"==typeof module&&module.exports?module.exports=i(require("cestino/Util")):t.Cestino.PriceFormatter=i(t.Cestino.Util)}(this,function(t){"use strict";function i(t,i,e){if(e=e||2,i=i||"",-1===[2,3].indexOf(e))throw new RangeError("The decimal count has to be 2 or 3!");if(-1===[".",",","Ù«"].indexOf(t))throw new RangeError(['"',t,'" is not a typical decimal seperator'].join(""));this.decimalCount=e,this.thousandsSeperator=i,this.decimalSeperator=t}function e(i,e){var n,o,r,i=i+"";if(!t.isInt(e))throw new TypeError("Parameter size has to be an Int!");for(n=Math.ceil(i.length/e),o=i.length%e||e,r=new Array(n);--n>0;)r[n]=i.substr((n-1)*e+o,e);return r[0]=i.substr(0,o),r}function n(i){var n;if(!t.isInt(i))throw new TypeError("Parameter int has to be an Int!");return n=parseInt((i+"").slice(0,-1*this.decimalCount)),[e(n,3).join(this.thousandsSeperator),this.decimalSeperator,t.lpad(i%Math.pow(10,this.decimalCount),this.decimalCount)].join("")}return i.prototype={format:n},{create:function(t,e,n){return new i(t,e,n)}}}),define(["cestino/Cart"],function(t){return t});